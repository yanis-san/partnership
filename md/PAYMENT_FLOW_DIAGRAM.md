# ğŸ“Š Diagrammes du Flux de Paiement

## 1. Architecture Globale du SystÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DASHBOARD ADMIN                          â”‚
â”‚              /partnerships/confirmations/                   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Partner: Librairie ABC                             â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚  â”‚ En Attente: 3 Ã— 1000 DA       ConfirmÃ©s: 50 âœ…    â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ Montant Acquis: 50 000 DA                          â”‚   â”‚
â”‚  â”‚ Montant PayÃ©:   35 000 DA      [ğŸ’³ Paiement] â†â”€â”€â”€â”€â”¼â”€â”€â”€â”¤ Click
â”‚  â”‚ Solde Restant:  15 000 DA      [ğŸ“‹ Historique]    â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ [Tableau des Ã©tudiants...]                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ MODAL PAYMENT (overlay)               â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚ Ajouter un paiement pour...     â”‚  â”‚
        â”‚ â”‚                                  â”‚  â”‚
        â”‚ â”‚ Montant payÃ© (DA): [______]     â”‚  â”‚
        â”‚ â”‚ Photo du reÃ§u:     [UPLOAD]     â”‚  â”‚
        â”‚ â”‚ Notes:             [_______]     â”‚  â”‚
        â”‚ â”‚                                  â”‚  â”‚
        â”‚ â”‚ [Valider] [Annuler]             â”‚  â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Flux Complet d'Ajout de Paiement (avec HTMX)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    UTILISATEUR                                 â•‘
â•‘                Clic sur "ğŸ’³ Paiement"                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTMX GET /partnerships/payment-form/<partner_id>/             â”‚
â”‚ hx-target="#payment-modal"                                     â”‚
â”‚ hx-swap="innerHTML"                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PaymentReceiptFormView.get()                           â”‚
â”‚                                                                â”‚
â”‚ 1. RÃ©cupÃ¨re le partenaire                                     â”‚
â”‚ 2. CrÃ©e un formulaire QuickPaymentForm()                      â”‚
â”‚ 3. Render: partials/payment-receipt-form.html                 â”‚
â”‚ 4. Retourne le HTML du formulaire                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: Modal s'affiche                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Ajouter un paiement pour Librairie ABC                   â”‚  â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚
â”‚ â”‚ Montant payÃ© (DA): [20000]                               â”‚  â”‚
â”‚ â”‚ Photo du reÃ§u:     [â–¶ PRENDRE PHOTO]                     â”‚  â”‚
â”‚ â”‚ Notes:             [Virement SGAB...]                    â”‚  â”‚
â”‚ â”‚                                                          â”‚  â”‚
â”‚ â”‚ [Valider le paiement] [Annuler]                          â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    UTILISATEUR                                 â•‘
â•‘         1. Saisit montant: 20000                               â•‘
â•‘         2. Prend photo du reÃ§u                                 â•‘
â•‘         3. Ajoute notes: "Virement le 25/11/2024"             â•‘
â•‘         4. Clic "Valider le paiement"                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTMX POST /partnerships/payment-upload/<partner_id>/          â”‚
â”‚                                                                â”‚
â”‚ enctype="multipart/form-data"                                 â”‚
â”‚ Data:                                                          â”‚
â”‚   - amount_paid: 20000                                        â”‚
â”‚   - receipt_image: <file binary>                              â”‚
â”‚   - notes: "Virement le 25/11/2024"                           â”‚
â”‚   - csrf_token: xxx                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVER: PaymentReceiptUploadView.post()                        â”‚
â”‚                                                                â”‚
â”‚ âœ… Valider formulaire (montant + image)                       â”‚
â”‚    â””â”€> OK                                                     â”‚
â”‚                                                                â”‚
â”‚ ğŸ“ CrÃ©er Payment record:                                      â”‚
â”‚    - library: Librairie ABC                                  â”‚
â”‚    - amount: 20000                                            â”‚
â”‚    - status: COMPLETED                                        â”‚
â”‚    - completed_at: now()                                      â”‚
â”‚    - remaining_amount: 0                                      â”‚
â”‚                                                                â”‚
â”‚ ğŸ“¸ CrÃ©er PaymentReceipt record:                               â”‚
â”‚    - payment: <Payment object>                                â”‚
â”‚    - receipt_image: receipts/2024/11/25/xxx.jpg              â”‚
â”‚    - amount_paid: 20000                                       â”‚
â”‚    - notes: "Virement le 25/11/2024"                          â”‚
â”‚                                                                â”‚
â”‚ ğŸ§® Recalculer montants du partenaire:                         â”‚
â”‚    - partner.total_paid = 35000 + 20000 = 55000             â”‚
â”‚    - partner.total_earned = 50000 (confirmÃ©s)                â”‚
â”‚    - solde = 50000 - 55000 = -5000 (PAYÃ‰ + 5000!)           â”‚
â”‚                                                                â”‚
â”‚ ğŸ Retourner: partials/payment-success.html                  â”‚
â”‚    Avec context:                                              â”‚
â”‚    - payment, receipt                                        â”‚
â”‚    - partner_paid_amount: 55000                              â”‚
â”‚    - partner_confirmed_amount: 50000                         â”‚
â”‚    - partner_solde: -5000                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  HTMX RESPONSE avec 2 SWAPS           â”‚
        â”‚                                        â”‚
        â”‚  [HTML #1] Swap principal:             â”‚
        â”‚  <div class="payment-success...">     â”‚
        â”‚    âœ… Paiement enregistrÃ©!            â”‚
        â”‚    Montant: 20 000 DA                 â”‚
        â”‚    ReÃ§u en aperÃ§u [IMAGE]            â”‚
        â”‚    ...                                 â”‚
        â”‚  </div>                               â”‚
        â”‚                                        â”‚
        â”‚  [HTML #2] Out-of-band swap OOB:     â”‚
        â”‚  <div id="partner-xyz-totals"        â”‚
        â”‚       hx-swap-oob="true"             â”‚
        â”‚       class="partner-header">         â”‚
        â”‚    Montant Acquis: 50 000 DA â†â”€â”    â”‚
        â”‚    Montant PayÃ©:   55 000 DA  â†â”¤ UPDATED!
        â”‚    Solde Restant: -5 000 DA   â†â”€â”˜    â”‚
        â”‚  </div>                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT: Mise Ã  jour du DOM en temps rÃ©el!                     â”‚
â”‚                                                                â”‚
â”‚ hx-target=".modal-content"                                   â”‚
â”‚ hx-swap="innerHTML"                                           â”‚
â”‚   â†’ Modal affiche le succÃ¨s + image du reÃ§u                   â”‚
â”‚                                                                â”‚
â”‚ hx-swap-oob="true" (Out-of-band swap)                        â”‚
â”‚   â†’ Le dashboard EN ARRIÃˆRE PLAN se met Ã  jour:              â”‚
â”‚      Montant PayÃ©: 20 000 â†’ 55 000 âœ…                        â”‚
â”‚      Solde: 50 000 â†’ -5 000 âœ…                               â”‚
â”‚      SUR LE MÃŠME PARTENAIRE!                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    UTILISATEUR VOIT                            â•‘
â•‘                                                                â•‘
â•‘  Modal (foreground):                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â•‘
â•‘  â”‚ âœ… Paiement enregistrÃ© avec succÃ¨s!  â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ 20 000 DA                            â”‚                    â•‘
â•‘  â”‚ 25/11/2024 Ã  14:32                   â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ [AperÃ§u du reÃ§u: IMAGE]              â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ Situation mise Ã  jour:                â”‚                    â•‘
â•‘  â”‚ Montant Acquis:  50 000 DA            â”‚                    â•‘
â•‘  â”‚ Montant PayÃ©:    55 000 DA â† UPDATED â”‚                    â•‘
â•‘  â”‚ Solde Restant:   -5 000 DA â† UPDATED â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ [Historique] [Autre paiement]         â”‚                    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â•‘
â•‘                                                                â•‘
â•‘  Dashboard (arriÃ¨re-plan):                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â•‘
â•‘  â”‚ Partner: Librairie ABC               â”‚                    â•‘
â•‘  â”‚ En Attente: 3Ã—1000  ConfirmÃ©s: 50 âœ…â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ Montant Acquis: 50 000 DA            â”‚                    â•‘
â•‘  â”‚ Montant PayÃ©:   55 000 DA â† UPDATED  â”‚                    â•‘
â•‘  â”‚ Solde Restant: -5 000 DA  â† UPDATED  â”‚                    â•‘
â•‘  â”‚                                      â”‚                    â•‘
â•‘  â”‚ [ğŸ’³ Paiement] [ğŸ“‹ Historique]       â”‚                    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 3. Flux Historique des ReÃ§us

```
USER CLICKS "ğŸ“‹ Historique"
            â†“
HTMX GET /partnerships/payment-history/<partner_id>/
            â†“
SERVER: PaymentReceiptListView.get_context_data()
  â”‚
  â”œâ”€ RÃ©cupÃ¨re le partenaire
  â”œâ”€ Fetch PaymentReceipt.objects.filter(payment__library=partner)
  â”‚  ORDER BY -created_at (plus rÃ©cents d'abord)
  â”‚
  â”œâ”€ Calcule les totaux:
  â”‚  - partner_paid_amount
  â”‚  - partner_confirmed_amount
  â”‚  - partner_solde
  â”‚
  â””â”€ Render: partner-payment-history.html
            â†“
CLIENT: Modal affiche la page d'historique
  â”‚
  â”œâ”€ Summary cards (Acquis, PayÃ©, Solde, Nb ReÃ§us)
  â”‚
  â”œâ”€ Liste des reÃ§us (RÃ©cents d'abord):
  â”‚  â””â”€ Pour chaque reÃ§u:
  â”‚     â”œâ”€ Header: NumÃ©ro, Date, Statut
  â”‚     â”œâ”€ Image du reÃ§u (cliquable pour agrandir)
  â”‚     â”œâ”€ Montant payÃ©
  â”‚     â”œâ”€ Date de paiement
  â”‚     â””â”€ Notes optionnelles
  â”‚
  â””â”€ Boutons:
     â”œâ”€ Ajouter un autre paiement
     â””â”€ Retour au dashboard
```

---

## 4. Architecture de la Base de DonnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PARTNER (Library)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                                       â”‚
â”‚ name                                            â”‚
â”‚ commission_per_student (1000 DA)                â”‚
â”‚ status                                          â”‚
â”‚ ...                                             â”‚
â”‚                                                 â”‚
â”‚ â†“ (reverse relation: .payments)                â”‚
â”‚ â†“ (reverse relation: .students)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“â†“â†“ LINK
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAYMENT                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                                       â”‚
â”‚ library_id (FK â†’ Partner) â—„â”€â”€â”€ 1:N             â”‚
â”‚ amount (20000)                                  â”‚
â”‚ status (completed)                              â”‚
â”‚ completed_at                                    â”‚
â”‚ remaining_amount (0)                            â”‚
â”‚ notes                                           â”‚
â”‚                                                 â”‚
â”‚ â†“ (reverse relation: .receipt)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ LINK (1:1)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAYMENTRECEIPT (NEW)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                                       â”‚
â”‚ payment_id (FK â†’ Payment, OneToOne) â—„â”€â”€ 1:1    â”‚
â”‚ receipt_image (receipts/2024/11/25/xxx.jpg)    â”‚
â”‚ amount_paid (20000)                             â”‚
â”‚ notes ("Virement SGAB")                         â”‚
â”‚ created_at                                      â”‚
â”‚ updated_at                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STUDENT                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID)                                        â”‚
â”‚ library_id (FK â†’ Partner) â—„â”€â”€â”€ 1:N              â”‚
â”‚ full_name                                        â”‚
â”‚ is_confirmed (True/False)                        â”‚
â”‚ ...                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RELATION DE CALCUL:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Montant Acquis = commission_per_student
                 Ã— COUNT(student WHERE is_confirmed=True)

Montant PayÃ© = SUM(Payment.amount WHERE status='completed')
               + SUM(PaymentReceipt.amount_paid)

Solde Restant = Montant Acquis - Montant PayÃ©
```

---

## 5. Flux des Fichiers

```
USER UPLOAD PHOTO
        â†“
form.receipt_image
        â†“
Django File Handler
        â†“
Enregistrer dans: media/receipts/2024/11/25/uuid_xxx.jpg
        â†“
PaymentReceipt.receipt_image = <ImageFieldFile>
        â†“
DATABASE: PaymentReceipt.receipt_image = "receipts/2024/11/25/uuid_xxx.jpg"
        â†“
TEMPLATE ACCESS:
  {% if receipt.receipt_image %}
    <img src="{{ receipt.receipt_image.url }}">
    <!-- URL: /media/receipts/2024/11/25/uuid_xxx.jpg -->
  {% endif %}
        â†“
BROWSER: Affiche l'image depuis /media/receipts/...
```

---

## 6. Ã‰tat de la Transparence

### ScÃ©nario: 4 Paiements sur 2 Cycles

```
CYCLE 1 (Janvier 2024)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã‰tat Initial:
  Ã‰tudiants confirmÃ©s: 50
  Montant Acquis: 50 000 DA
  Montant PayÃ©: 0 DA
  Solde: 50 000 DA

Paiement 1: 30 000 DA (10/01/2024)
  Montant PayÃ©: 30 000 DA
  Solde: 20 000 DA

Paiement 2: 20 000 DA (20/01/2024)
  Montant PayÃ©: 50 000 DA
  Solde: 0 DA âœ… (Cycle 1 terminÃ©)


CYCLE 2 (Mars 2024)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã‰tat Initial (NOUVEAU CYCLE):
  Ã‰tudiants confirmÃ©s: 45 (NEW STUDENTS)
  Montant Acquis: 45 000 DA (RESET)
  Montant PayÃ©: 50 000 DA (ANCIEN CYCLE - CONSERVÃ‰)
  Solde: -5 000 DA (CrÃ©dit!)

Note: Pas d'accumulation! Les montants du cycle 1
      ne sont pas rÃ©pÃ©tÃ©s. Chaque cycle a ses propres
      Ã©tudiants et Montant Acquis.

Paiement 3: 40 000 DA (15/03/2024)
  Montant Acquis: 45 000 DA
  Montant PayÃ©: 90 000 DA (50 000 + 40 000)
  Solde: -45 000 DA (CrÃ©dit important!)

Paiement 4: 5 000 DA (25/03/2024)
  Montant Acquis: 45 000 DA
  Montant PayÃ©: 95 000 DA
  Solde: -50 000 DA (CrÃ©dit complet)


HISTORIQUE COMPLET:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ReÃ§u 1: 30 000 DA - 10/01/2024
ReÃ§u 2: 20 000 DA - 20/01/2024 [Cycle 1]
ReÃ§u 3: 40 000 DA - 15/03/2024
ReÃ§u 4:  5 000 DA - 25/03/2024 [Cycle 2]

TOTAL PAYÃ‰: 95 000 DA (CORRECT!)
```

---

## 7. Checklist de VÃ©rification

```
âœ… ModÃ¨les Django
   â”œâ”€ PaymentReceipt crÃ©Ã©
   â”œâ”€ Relation 1:1 avec Payment
   â””â”€ Migration 0002 appliquÃ©e

âœ… Formulaires
   â”œâ”€ QuickPaymentForm fonctionnel
   â”œâ”€ Validation montant
   â””â”€ Upload image OK

âœ… Vues HTMX
   â”œâ”€ PaymentReceiptFormView (GET)
   â”œâ”€ PaymentReceiptUploadView (POST)
   â””â”€ PaymentReceiptListView (GET)

âœ… Templates
   â”œâ”€ payment-receipt-form.html
   â”œâ”€ payment-success.html (avec OOB)
   â”œâ”€ partner-payment-history.html
   â””â”€ admin-student-confirmation.html (modal intÃ©grÃ©)

âœ… URLs
   â”œâ”€ /payment-form/<id>/
   â”œâ”€ /payment-upload/<id>/
   â””â”€ /payment-history/<id>/

âœ… Frontend HTMX
   â”œâ”€ Boutons ğŸ’³ et ğŸ“‹ visibles
   â”œâ”€ Modal affichage OK
   â”œâ”€ Out-of-band swaps fonctionnels
   â””â”€ Navigation fluide

âœ… Fichiers
   â”œâ”€ Stockage media/receipts/
   â”œâ”€ Permissions OK
   â””â”€ AccÃ¨s direct possible

âœ… SÃ©curitÃ©
   â”œâ”€ Superuser only
   â”œâ”€ CSRF protection
   â”œâ”€ Validation serveur
   â””â”€ Pas de modification post-paiement
```

---

**RÃ©sumÃ©:** SystÃ¨me entiÃ¨rement fonctionnel, prÃªt pour la production! ğŸš€
